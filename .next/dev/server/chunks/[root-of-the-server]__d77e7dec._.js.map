{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/darshanchipade/Documents/GitHub/UserFlow/UserFlow/src/app/api/ingestion/cleansed-items/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\nconst backendBaseUrl = process.env.SPRINGBOOT_BASE_URL;\n\nconst safeParse = (payload: string) => {\n  try {\n    return JSON.parse(payload);\n  } catch {\n    return payload;\n  }\n};\n\ntype NormalizedRow = {\n  id: string;\n  field: string;\n  original?: string | null;\n  cleansed?: string | null;\n};\n\nconst pickString = (value: unknown): string | undefined => {\n  if (typeof value !== \"string\") return undefined;\n  const trimmed = value.trim();\n  return trimmed.length ? trimmed : undefined;\n};\n\nconst isRecord = (value: unknown): value is Record<string, unknown> => {\n  return typeof value === \"object\" && value !== null;\n};\n\nconst pickFromSources = (\n  sources: Array<Record<string, unknown>>,\n  keys: string[],\n  forbiddenValues?: string[],\n) => {\n  for (const key of keys) {\n    if (!key) continue;\n    for (const source of sources) {\n      const candidate = pickString(source[key]);\n      if (!candidate) continue;\n      if (\n        forbiddenValues?.some(\n          (forbiddenValue) => forbiddenValue && candidate.trim() === forbiddenValue.trim(),\n        )\n      ) {\n        continue;\n      }\n      return candidate;\n    }\n  }\n  return undefined;\n};\n\nconst normalizeItems = (payload: unknown): NormalizedRow[] => {\n  const extractRawItems = (): unknown[] => {\n    if (Array.isArray(payload)) return payload;\n    if (isRecord(payload)) {\n      if (Array.isArray(payload.items)) return payload.items as unknown[];\n      if (Array.isArray(payload.records)) return payload.records as unknown[];\n      if (Array.isArray(payload.data)) return payload.data as unknown[];\n    }\n    return [];\n  };\n\n  const FIELD_KEYS = [\n    \"field\",\n    \"label\",\n    \"key\",\n    \"name\",\n    \"originalFieldName\",\n    \"fieldName\",\n    \"itemType\",\n  ];\n  const ORIGINAL_KEYS = [\n    \"originalValue\",\n    \"rawValue\",\n    \"sourceValue\",\n    \"before\",\n    \"input\",\n    \"valueBefore\",\n    \"value\",\n    \"copy\",\n    \"text\",\n    \"content\",\n  ];\n  const CLEANSED_KEYS = [\n    \"cleansedValue\",\n    \"cleanedValue\",\n    \"normalizedValue\",\n    \"after\",\n    \"output\",\n    \"valueAfter\",\n    \"value\",\n    \"cleansedContent\",\n    \"cleansedCopy\",\n  ];\n\n  return extractRawItems()\n    .map((item, index) => {\n      if (!isRecord(item)) return null;\n      const context = isRecord(item.context) ? item.context : undefined;\n      const facets = context && isRecord(context.facets) ? (context.facets as Record<string, unknown>) : undefined;\n\n      const sources: Array<Record<string, unknown>> = [item];\n      if (context) sources.push(context);\n      if (facets) sources.push(facets);\n\n      const field =\n        pickFromSources(sources, FIELD_KEYS) ??\n        `Item ${index + 1}`;\n      const original = pickFromSources(sources, ORIGINAL_KEYS, field ? [field] : undefined);\n      const cleansed = pickFromSources(sources, CLEANSED_KEYS, field ? [field] : undefined);\n\n      return {\n        id: pickString(item.id) ?? pickString(item.contentHash) ?? `row-${index}`,\n        field,\n        original: original ?? null,\n        cleansed: cleansed ?? null,\n      };\n    })\n    .filter((row): row is NormalizedRow => Boolean(row));\n};\n\nexport async function GET(request: NextRequest) {\n  if (!backendBaseUrl) {\n    return NextResponse.json(\n      { error: \"SPRINGBOOT_BASE_URL is not configured.\" },\n      { status: 500 },\n    );\n  }\n\n  const id = request.nextUrl.searchParams.get(\"id\");\n  if (!id) {\n    return NextResponse.json(\n      { error: \"Missing required `id` query parameter.\" },\n      { status: 400 },\n    );\n  }\n\n  try {\n    const targetUrl = new URL(`/api/cleansed-items/${id}`, backendBaseUrl);\n    const upstream = await fetch(targetUrl);\n    const rawBody = await upstream.text();\n    const body = safeParse(rawBody);\n    const items = normalizeItems(body);\n\n    return NextResponse.json(\n      {\n        upstreamStatus: upstream.status,\n        upstreamOk: upstream.ok,\n        items,\n        rawBody,\n      },\n      { status: upstream.ok ? 200 : upstream.status },\n    );\n  } catch (error) {\n    return NextResponse.json(\n      {\n        error:\n          error instanceof Error ? error.message : \"Unable to reach Spring Boot backend.\",\n      },\n      { status: 502 },\n    );\n  }\n}"],"names":[],"mappings":"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"}}]
}