(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[31],{8629:(e,t,s)=>{Promise.resolve().then(s.bind(s,6621))},6621:(e,t,s)=>{"use strict";s.d(t,{default:()=>g});var l=s(5155),a=s(2115),n=s(6046),d=s(7997),i=s(5446),r=s(8183),o=s(5863);let c=[{title:"Whitespace normalization",description:"Collapses redundant spaces, tabs, and line breaks to a single space."},{title:"Markup removal",description:"Strips internal tokens (e.g. {%url%}, sosumi, wj markers) from copy blocks."},{title:"Locale-aware punctuation",description:"Replaces smart quotes, ellipsis, and em-dashes with locale-specific glyphs."},{title:"Sensitive token scrub",description:"Masks e-mail addresses, PII placeholders, and debugging metadata."}],u=e=>e?{metadata:e.metadata,status:e.status,rawBody:e.rawBody,fallbackReason:e.fallbackReason,cachedItems:m(e.items)}:null,m=e=>Array.isArray(e)?e.reduce((e,t,s)=>{var l;if(!t||"object"!=typeof t)return e;let a=(0,o.Xl)(t.field),n=(0,o.Xl)(t.original),d=(0,o.Xl)(t.cleansed);return(a||n||d)&&e.push({id:null!==(l=(0,o.Xl)(t.id))&&void 0!==l?l:"cached-".concat(s),field:null!=a?a:"Item ".concat(s+1),original:null!=n?n:null,cleansed:null!=d?d:null}),e},[]):[],x=async e=>{let t=await e.text(),s=t.trim(),l=null;if(s.length)try{l=JSON.parse(s)}catch(e){l=null}return{body:l,rawBody:(s.startsWith("<!DOCTYPE")||s.startsWith("<html"))&&e.status?"".concat(e.status," ").concat(e.statusText||"").trim()||"HTML response returned.":t}},h=e=>{if("number"==typeof e&&Number.isFinite(e))return e},p=(e,t)=>null!=t?t:{name:"Unknown dataset",size:0,source:"Unknown source",uploadedAt:Date.now(),cleansedId:e},b=(e,t,s)=>{var l,a,n,d,i,r,c,u,m,x,p,b;if(!e)return t;let f=e.metadata&&"object"==typeof e.metadata?e.metadata:null,g={...t};if(f){g.name=null!==(l=(0,o.Xl)(f.name))&&void 0!==l?l:g.name,g.source=null!==(a=(0,o.Xl)(f.source))&&void 0!==a?a:g.source,g.cleansedId=null!==(n=(0,o.Xl)(f.cleansedId))&&void 0!==n?n:g.cleansedId,g.status=null!==(d=(0,o.Xl)(f.status))&&void 0!==d?d:g.status,g.sourceIdentifier=null!==(i=(0,o.Xl)(f.sourceIdentifier))&&void 0!==i?i:g.sourceIdentifier,g.sourceType=null!==(r=(0,o.Xl)(f.sourceType))&&void 0!==r?r:g.sourceType;let e=h(f.uploadedAt);e&&(g.uploadedAt=e);let t=h(f.size);void 0!==t&&(g.size=t)}let v=null!==(u=null!==(c=(0,o.Xl)(e.sourceIdentifier))&&void 0!==c?c:(0,o.Xl)(e.sourceUri))&&void 0!==u?u:g.sourceIdentifier,j=null!==(m=(0,o.Me)((0,o.Xl)(e.sourceType),null!=v?v:g.sourceIdentifier,g.sourceType))&&void 0!==m?m:g.sourceType;return g.sourceIdentifier=null!=v?v:g.sourceIdentifier,g.sourceType=j,g.source=(0,o.VG)(j,g.source),g.cleansedId=null!==(b=null!==(p=null!==(x=(0,o.Xl)(e.cleansedId))&&void 0!==x?x:(0,o.Xl)(e.cleansedDataStoreId))&&void 0!==p?p:g.cleansedId)&&void 0!==b?b:s,g},f=e=>{var t;let{feedback:s}=e;if("idle"===s.state)return null;let a="loading"===s.state?"bg-indigo-50 text-indigo-600":"success"===s.state?"bg-emerald-50 text-emerald-700":"bg-rose-50 text-rose-700";return(0,l.jsx)("div",{className:"inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ".concat(a),children:"loading"===s.state?"Triggering enrichment…":null!==(t=s.message)&&void 0!==t?t:"success"===s.state?"Enrichment triggered.":"Something went wrong."})};function g(){var e,t,s,m,h;let g=(0,n.useRouter)(),v=(0,n.useSearchParams)().get("id"),j=u((0,d.DV)()),[y,w]=(0,a.useState)(j),[N,k]=(0,a.useState)(null!==(e=null==j?void 0:j.cachedItems)&&void 0!==e?e:[]),[I,S]=(0,a.useState)(!j),[C,E]=(0,a.useState)(null),[R,T]=(0,a.useState)({state:"idle"}),[X,B]=(0,a.useState)(!1),[U,A]=(0,a.useState)(null),[O,D]=(0,a.useState)(null),[P,_]=(0,a.useState)(!1);(0,a.useEffect)(()=>{_(!0)},[]),(0,a.useEffect)(()=>{var e;let t=null!==(e=null==j?void 0:j.metadata.cleansedId)&&void 0!==e?e:null;D(null!=v?v:t)},[v,null==j?void 0:j.metadata.cleansedId]);let q=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{showSpinner:s=!0}=t;s&&B(!0),A(null);try{let t=await fetch("/api/ingestion/cleansed-items?id=".concat(encodeURIComponent(e))),{body:s,rawBody:n}=await x(t);if(!t.ok){var l,a;if(404===t.status){k([]),A("Cleansed rows are not available yet.");return}throw Error(null!==(a=null!==(l=null==s?void 0:s.error)&&void 0!==l?l:n)&&void 0!==a?a:"Backend rejected the items request.")}let d=null!=s?s:{},i=Array.isArray(d.items)?d.items:[];k(i),w(e=>e?{...e,cachedItems:i,rawBody:"string"==typeof(null==s?void 0:s.rawBody)?s.rawBody:e.rawBody}:e)}catch(e){A(e instanceof Error?e.message:"Unable to fetch cleansed items.")}finally{s&&B(!1)}};(0,a.useEffect)(()=>{(async e=>{var t,s,l,a,n,d,i,r,c,u,m;if(!e){S(!1),E("Provide a cleansed ID via the URL or trigger a new run."),w(j),k(null!==(t=null==j?void 0:j.cachedItems)&&void 0!==t?t:[]);return}S(!0),E(null);try{let t=await fetch("/api/ingestion/cleansed-context?id=".concat(encodeURIComponent(e))),{body:m,rawBody:h}=await x(t);if(!t.ok)throw Error(null!==(n=null!==(a=null==m?void 0:m.error)&&void 0!==a?a:h)&&void 0!==n?n:"Backend rejected the cleansed context request.");let f=null!=m?m:{},g=null;f.body&&"object"==typeof f.body?g=f.body:"body"in f||"object"!=typeof f||(g=f);let v=p(e,null!==(d=null==j?void 0:j.metadata)&&void 0!==d?d:void 0),y=b(g,v,e),N=null!==(i=(0,o.Xl)(f.rawBody))&&void 0!==i?i:"string"==typeof h?h:void 0,I={metadata:y,status:null!==(r=(0,o.Xl)(null==g?void 0:g.status))&&void 0!==r?r:null==j?void 0:j.status,rawBody:N,fallbackReason:null!==(u=null!==(c=(0,o.Xl)(f.fallbackReason))&&void 0!==c?c:(0,o.Xl)(null==g?void 0:g.fallbackReason))&&void 0!==u?u:null==j?void 0:j.fallbackReason};w(I),(null===(s=I.cachedItems)||void 0===s?void 0:s.length)&&k(I.cachedItems),await q(e,{showSpinner:!(null===(l=I.cachedItems)||void 0===l?void 0:l.length)})}catch(e){E(e instanceof Error?e.message:"Unable to load cleansed context."),j?(w(j),k(null!==(m=j.cachedItems)&&void 0!==m?m:[])):(w(null),k([]))}finally{S(!1)}})(O)},[O]);let F=async()=>{if(!(null==y?void 0:y.metadata.cleansedId)){T({state:"error",message:"Cleansed ID is missing. Re-run extraction before enrichment."});return}T({state:"loading",message:"Triggering enrichment…"});try{var e,t;let s=await fetch("/api/ingestion/enrichment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:y.metadata.cleansedId})}),l=await s.json();if(!s.ok){T({state:"error",message:null!==(t=null==l?void 0:l.error)&&void 0!==t?t:"Backend rejected the request."});return}let a=Date.now();(0,d.q6)({metadata:y.metadata,startedAt:a,statusHistory:[{status:"ENRICHMENT_TRIGGERED",timestamp:a},{status:"string"==typeof(null==l?void 0:null===(e=l.body)||void 0===e?void 0:e.status)?l.body.status:"WAITING_FOR_RESULTS",timestamp:a}]}),T({state:"success",message:"Enrichment pipeline triggered."}),g.push("/enrichment?id=".concat(encodeURIComponent(y.metadata.cleansedId)))}catch(e){T({state:"error",message:e instanceof Error?e.message:"Unable to reach enrichment service."})}};if(I||!P)return(0,l.jsx)("div",{className:"flex min-h-screen items-center justify-center bg-slate-50 px-6 py-16",children:(0,l.jsxs)("div",{className:"max-w-lg rounded-3xl border border-slate-200 bg-white p-10 text-center shadow-sm",children:[(0,l.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Cleansing"}),(0,l.jsx)("h1",{className:"mt-2 text-2xl font-semibold text-slate-900",children:"Loading context…"}),(0,l.jsx)("p",{className:"mt-3 text-sm text-slate-500",children:"Fetching cleansed snapshot from the backend. One moment please."})]})});if(!y)return(0,l.jsx)("div",{className:"flex min-h-screen items-center justify-center bg-slate-50 px-6 py-16",children:(0,l.jsxs)("div",{className:"max-w-lg rounded-3xl border border-slate-200 bg-white p-10 text-center shadow-sm",children:[(0,l.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Cleansing"}),(0,l.jsx)("h1",{className:"mt-2 text-2xl font-semibold text-slate-900",children:null!=C?C:"Cleansed context not found"}),(0,l.jsx)("p",{className:"mt-3 text-sm text-slate-500",children:"Provide a valid `id` query parameter or trigger the pipeline again."}),(0,l.jsx)("button",{type:"button",onClick:()=>g.push("/extraction"),className:"mt-6 rounded-full bg-slate-900 px-6 py-2 text-sm font-semibold text-white",children:"Back to Extraction"})]})});let L=(0,o.VG)(null!==(t=y.metadata.sourceType)&&void 0!==t?t:y.metadata.source,y.metadata.source),G=null!==(s=y.metadata.sourceIdentifier)&&void 0!==s?s:"—";return(0,l.jsxs)(i.l,{currentStep:"cleansing",children:[(0,l.jsx)(r.F,{title:"Cleansing",description:"Review cleansed output for ".concat(y.metadata.name," before sending it forward."),actionsSlot:(0,l.jsx)(f,{feedback:R})}),(0,l.jsxs)("main",{className:"mx-auto flex max-w-6xl flex-col gap-6 px-6 py-10",children:[(0,l.jsxs)("section",{className:"rounded-3xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,l.jsxs)("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Status"}),(0,l.jsx)("h2",{className:"text-lg font-semibold text-slate-900",children:null!==(m=y.status)&&void 0!==m?m:"Pending"})]}),(0,l.jsxs)("div",{className:"text-xs text-slate-500",children:[(0,l.jsx)("p",{children:"Uploaded"}),(0,l.jsx)("p",{className:"font-semibold text-slate-800",children:new Date(y.metadata.uploadedAt).toLocaleString()})]})]}),(0,l.jsxs)("div",{className:"mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("dt",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Cleansed ID"}),(0,l.jsx)("dd",{className:"text-sm font-semibold text-slate-900",children:null!==(h=y.metadata.cleansedId)&&void 0!==h?h:"—"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("dt",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Source"}),(0,l.jsx)("dd",{className:"text-sm font-semibold text-slate-900",children:L})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("dt",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Source identifier"}),(0,l.jsx)("dd",{className:"text-sm font-semibold text-slate-900 break-all",children:G})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("dt",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Cache status"}),(0,l.jsx)("dd",{className:"text-sm font-semibold text-slate-900",children:"quota"===y.fallbackReason?"Partial snapshot":"Complete snapshot"})]})]})]}),(0,l.jsxs)("section",{className:"rounded-3xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,l.jsx)("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between",children:(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Items"}),(0,l.jsx)("h2",{className:"text-lg font-semibold text-slate-900",children:"Original vs Cleansed values"})]})}),X?(0,l.jsx)("div",{className:"mt-4 rounded-2xl border border-slate-200 bg-slate-50 py-10 text-center text-sm text-slate-600",children:"Fetching latest cleansed rows…"}):U?(0,l.jsxs)("div",{className:"mt-4 rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900",children:[(0,l.jsx)("p",{className:"font-semibold",children:"Unable to load cleansed items."}),(0,l.jsx)("p",{className:"mt-1",children:U}),(0,l.jsx)("button",{type:"button",onClick:()=>y.metadata.cleansedId&&q(y.metadata.cleansedId),className:"mt-3 rounded-full bg-amber-600 px-3 py-1 text-xs font-semibold text-white",children:"Retry fetch"})]}):0===N.length?(0,l.jsx)("div",{className:"mt-4 rounded-2xl border border-dashed border-slate-200 py-10 text-center text-sm text-slate-500",children:"No cleansed items available yet."}):(0,l.jsx)("div",{className:"mt-4 rounded-2xl border border-slate-100",children:(0,l.jsx)("div",{className:"max-h-[480px] overflow-y-auto",children:(0,l.jsxs)("table",{className:"w-full text-left text-sm",children:[(0,l.jsx)("thead",{className:"bg-slate-50 text-xs uppercase tracking-wide text-slate-500",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Field"}),(0,l.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Original value"}),(0,l.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Cleansed value"})]})}),(0,l.jsx)("tbody",{className:"divide-y divide-slate-100 bg-white",children:N.map((e,t)=>{var s,a,n,d;return(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{className:"px-4 py-3 align-top font-semibold text-slate-900",children:e.field}),(0,l.jsx)("td",{className:"px-4 py-3 align-top text-slate-700",children:(0,l.jsx)("pre",{className:"whitespace-pre-wrap text-xs",children:null!==(s=e.original)&&void 0!==s?s:"—"})}),(0,l.jsx)("td",{className:"px-4 py-3 align-top text-slate-700",children:(0,l.jsx)("pre",{className:"whitespace-pre-wrap text-xs",children:null!==(a=e.cleansed)&&void 0!==a?a:"—"})})]},null!==(d=e.id)&&void 0!==d?d:"".concat(null!==(n=e.field)&&void 0!==n?n:"row","-").concat(t))})})]})})})]}),(0,l.jsx)("section",{className:"rounded-3xl border border-slate-200 bg-white p-6 shadow-sm",children:(0,l.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Applied rules"}),(0,l.jsx)("h2",{className:"text-lg font-semibold text-slate-900",children:"Cleansing heuristics snapshot"})]}),(0,l.jsx)("div",{className:"grid gap-4 md:grid-cols-2",children:c.map(e=>(0,l.jsxs)("div",{className:"rounded-2xl border border-slate-100 bg-slate-50 p-4 shadow-inner",children:[(0,l.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:e.title}),(0,l.jsx)("p",{className:"mt-1 text-xs text-slate-600",children:e.description})]},e.title))})]})}),(0,l.jsx)("section",{className:"rounded-3xl border border-slate-200 bg-white p-6 shadow-sm",children:(0,l.jsxs)("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Next steps"}),(0,l.jsx)("h2",{className:"text-lg font-semibold text-slate-900",children:"Ready to send for enrichment?"})]}),(0,l.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,l.jsx)("button",{type:"button",onClick:()=>g.push("/extraction"),className:"rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-700",children:"Back to Extraction"}),(0,l.jsx)("button",{type:"button",onClick:F,disabled:"loading"===R.state,className:"rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-70",children:"loading"===R.state?"Sending to Enrichment…":"Send to Enrichment"}),(0,l.jsx)("button",{type:"button",onClick:()=>{(0,d.sB)(),g.push("/ingestion")},className:"rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-700",children:"Start Over"})]})]})})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[550,995,441,517,358],()=>t(8629)),_N_E=e.O()}]);