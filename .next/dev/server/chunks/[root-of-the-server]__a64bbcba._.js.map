{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/darshanchipade/Documents/GitHub/UserFlow/UserFlow/src/app/api/ingestion/enrichment/result/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\nconst backendBaseUrl = process.env.SPRINGBOOT_BASE_URL;\n\nconst safeParse = (payload: string) => {\n  try {\n    return JSON.parse(payload);\n  } catch {\n    return payload;\n  }\n};\n\nconst pickString = (value: unknown): string | undefined => {\n  if (typeof value !== \"string\") return undefined;\n  const trimmed = value.trim();\n  return trimmed.length ? trimmed : undefined;\n};\n\nconst toArray = (value: unknown): unknown[] => {\n  if (Array.isArray(value)) return value;\n  if (value && typeof value === \"object\") {\n    const record = value as Record<string, unknown>;\n    const candidates = [\n      record.items,\n      record.records,\n      record.data,\n      record.result,\n      record.entries,\n      record.enrichedItems,\n      record.consolidatedItems,\n      record.payload,\n    ];\n    for (const candidate of candidates) {\n      if (Array.isArray(candidate)) {\n        return candidate;\n      }\n    }\n  }\n  return [];\n};\n\nconst toStringList = (value: unknown): string[] => {\n  if (!value) return [];\n  if (Array.isArray(value)) {\n    return value\n      .map((entry) => pickString(entry))\n      .filter((entry): entry is string => Boolean(entry));\n  }\n  const asString = pickString(value);\n  if (!asString) return [];\n  if (asString.includes(\",\")) {\n    return asString\n      .split(\",\")\n      .map((token) => token.trim())\n      .filter(Boolean);\n  }\n  return [asString];\n};\n\ntype EnrichmentDetail = {\n  id: string;\n  cleansedItem: string;\n  summary?: string;\n  tags: string[];\n  sentiments: string[];\n};\n\nconst FIELD_KEYS = [\n  \"cleansedItem\",\n  \"cleansedContent\",\n  \"item\",\n  \"field\",\n  \"label\",\n  \"title\",\n  \"name\",\n  \"copy\",\n  \"original\",\n];\n\nconst SUMMARY_KEYS = [\n  \"summary\",\n  \"aiSummary\",\n  \"analysis\",\n  \"description\",\n  \"insight\",\n  \"text\",\n  \"content\",\n];\n\nconst TAG_KEYS = [\"tags\", \"topics\", \"labels\", \"categories\"];\nconst SENTIMENT_KEYS = [\"sentiments\", \"sentiment\", \"tone\", \"tones\"];\n\nconst pickFromSources = (sources: Array<Record<string, unknown>>, keys: string[]): string | undefined => {\n  for (const key of keys) {\n    for (const source of sources) {\n      const candidate = pickString(source[key]);\n      if (candidate) {\n        return candidate;\n      }\n    }\n  }\n  return undefined;\n};\n\nconst pickArrayFromSources = (sources: Array<Record<string, unknown>>, keys: string[]): string[] => {\n  for (const key of keys) {\n    for (const source of sources) {\n      const candidate = source[key];\n      const normalized = toStringList(candidate);\n      if (normalized.length) {\n        return normalized;\n      }\n    }\n  }\n  return [];\n};\n\nconst normalizeEnrichmentDetails = (payload: unknown): EnrichmentDetail[] => {\n  const rows = toArray(payload)\n    .map((entry, index) => {\n      if (!entry || typeof entry !== \"object\") return null;\n      const record = entry as Record<string, unknown>;\n      const context = typeof record.context === \"object\" && record.context !== null\n        ? (record.context as Record<string, unknown>)\n        : null;\n      const metadata = typeof record.metadata === \"object\" && record.metadata !== null\n        ? (record.metadata as Record<string, unknown>)\n        : null;\n      const facets = context && typeof context.facets === \"object\" && context.facets !== null\n        ? (context.facets as Record<string, unknown>)\n        : null;\n\n      const sources: Array<Record<string, unknown>> = [record];\n      if (context) sources.push(context);\n      if (facets) sources.push(facets);\n      if (metadata) sources.push(metadata);\n\n      const label =\n        pickFromSources(sources, FIELD_KEYS) ??\n        `Item ${index + 1}`;\n      const summary = pickFromSources(sources, SUMMARY_KEYS);\n      const tags = pickArrayFromSources(sources, TAG_KEYS);\n      const sentiments = pickArrayFromSources(sources, SENTIMENT_KEYS);\n\n      return {\n        id: pickString(record.id) ?? pickString(record.cleansedDataStoreId) ?? pickString(record.contentHash) ?? `enrichment-${index}`,\n        cleansedItem: label,\n        summary: summary ?? undefined,\n        tags,\n        sentiments,\n      } as EnrichmentDetail;\n    })\n    .filter((row): row is EnrichmentDetail => Boolean(row));\n\n  return rows;\n};\n\nconst buildSummaryText = (details: EnrichmentDetail[], fallback: unknown): string | undefined => {\n  if (details.length) {\n    return details\n      .map((detail) => {\n        const headline = detail.cleansedItem;\n        const summary = detail.summary ?? \"Awaiting summary.\";\n        const tagsLine = detail.tags.length ? `Tags: ${detail.tags.join(\", \")}` : null;\n        const sentimentsLine = detail.sentiments.length ? `Sentiments: ${detail.sentiments.join(\", \")}` : null;\n        return [`${headline}: ${summary}`, tagsLine, sentimentsLine]\n          .filter(Boolean)\n          .join(\"\\n\");\n      })\n      .join(\"\\n\\n\");\n  }\n  const fallbackText = pickString(fallback);\n  return fallbackText ?? undefined;\n};\n\nexport async function GET(request: NextRequest) {\n  if (!backendBaseUrl) {\n    return NextResponse.json(\n      { error: \"SPRINGBOOT_BASE_URL is not configured.\" },\n      { status: 500 },\n    );\n  }\n\n  const id = request.nextUrl.searchParams.get(\"id\");\n  if (!id) {\n    return NextResponse.json(\n      { error: \"Missing required `id` query parameter.\" },\n      { status: 400 },\n    );\n  }\n\n  try {\n    const resultUrl = new URL(`/api/enrichment/result/${id}`, backendBaseUrl);\n    const upstream = await fetch(resultUrl);\n    const rawBody = await upstream.text();\n    const body = safeParse(rawBody);\n    const details = normalizeEnrichmentDetails(body);\n    const summaryText = buildSummaryText(details, rawBody);\n\n    return NextResponse.json(\n      {\n        upstreamStatus: upstream.status,\n        upstreamOk: upstream.ok,\n        details,\n        summary: summaryText,\n        body,\n        rawBody,\n      },\n      { status: upstream.ok ? 200 : upstream.status },\n    );\n  } catch (error) {\n    return NextResponse.json(\n      {\n        error:\n          error instanceof Error\n            ? error.message\n            : \"Unable to reach Spring Boot enrichment result endpoint.\",\n      },\n      { status: 502 },\n    );\n  }\n}"],"names":[],"mappings":"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"}}]
}